normalizeEmptyValue <- function(x) {
  if (is.null(x) || is.na(x) || "NA" == x || "NULL" == x) {
    character()
  } else {
    x
  }
}

generateAOProcedureReports <- function(connectionDetails, proceduresData, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, outputPath)
{
  writeLines("Generating procedure reports")
  queryPrevalenceByGenderAgeYear <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/procedure/sqlPrevalenceByGenderAgeYear.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryPrevalenceByMonth <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/procedure/sqlPrevalenceByMonth.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryProcedureFrequencyDistribution <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/procedure/sqlFrequencyDistribution.sql", 
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryProceduresByType <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/procedure/sqlProceduresByType.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryAgeAtFirstOccurrence <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/procedure/sqlAgeAtFirstOccurrence.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  conn <- DatabaseConnector::connect(connectionDetails)
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  dataPrevalenceByGenderAgeYear <- DatabaseConnector::querySql(conn,queryPrevalenceByGenderAgeYear) 
  dataPrevalenceByMonth <- DatabaseConnector::querySql(conn,queryPrevalenceByMonth)  
  dataProceduresByType <- DatabaseConnector::querySql(conn,queryProceduresByType)    
  dataAgeAtFirstOccurrence <- DatabaseConnector::querySql(conn,queryAgeAtFirstOccurrence)    
  dataProcedureFrequencyDistribution <- DatabaseConnector::querySql(conn,queryProcedureFrequencyDistribution)

  if (nrow(proceduresData) == 0) {
    return()
  }
  uniqueConcepts <- data.frame(
    CONCEPT_ID = unique(proceduresData$CONCEPT_ID),
    CDM_TABLE_NAME = "PROCEDURE_OCCURRENCE"
  )
  reports <-
    uniqueConcepts %>%
    dplyr::left_join(
      proceduresData,
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::select("CONCEPT_ID", "CONCEPT_NAME", "CDM_TABLE_NAME", "NUM_PERSONS", "PERCENT_PERSONS", "RECORDS_PER_PERSON") %>%
    dplyr::left_join(
      (
        dataPrevalenceByGenderAgeYear %>%
        dplyr::select(c(1,3,4,5,6)) %>%
        tidyr::nest(PREVALENCE_BY_GENDER_AGE_YEAR = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByMonth %>%
        dplyr::select(c(1,3,4)) %>%
        tidyr::nest(PREVALENCE_BY_MONTH = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataProcedureFrequencyDistribution %>%
        dplyr::select(c(1,3,4)) %>%
        tidyr::nest(PROCEDURE_FREQUENCY_DISTRIBUTION = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataProceduresByType %>%
        dplyr::select(c(1,4,5)) %>%
        tidyr::nest(PROCEDURES_BY_TYPE = c(-1))
      ),
      by = c("CONCEPT_ID" = "PROCEDURE_CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataAgeAtFirstOccurrence %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(AGE_AT_FIRST_OCCURRENCE = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::collect()

  dir.create(paste0(outputPath,"/concepts/procedure_occurrence"),recursive=T,showWarnings = F)
  x <- lapply(
    uniqueConcepts$CONCEPT_ID,
    function(concept_id, outputPath, reports) {
      report <- reports[reports$CONCEPT_ID == concept_id, ]
      report <- as.list(report)

      report$CONCEPT_NAME <- normalizeEmptyValue(report$CONCEPT_NAME)
      report$NUM_PERSONS <- normalizeEmptyValue(report$NUM_PERSONS)
      report$PERCENT_PERSONS <- normalizeEmptyValue(report$PERCENT_PERSONS)
      report$RECORDS_PER_PERSON <- normalizeEmptyValue(report$RECORDS_PER_PERSON)

      report$PREVALENCE_BY_GENDER_AGE_YEAR <- as.data.frame(report$PREVALENCE_BY_GENDER_AGE_YEAR)
      report$PREVALENCE_BY_MONTH <- as.data.frame(report$PREVALENCE_BY_MONTH)
      report$PROCEDURE_FREQUENCY_DISTRIBUTION <- as.data.frame(report$PROCEDURE_FREQUENCY_DISTRIBUTION)
      report$PROCEDURES_BY_TYPE <- as.data.frame(report$PROCEDURES_BY_TYPE)
      report$AGE_AT_FIRST_OCCURRENCE <- as.data.frame(report$AGE_AT_FIRST_OCCURRENCE)

      filename <- paste(outputPath, "/concepts/procedure_occurrence/concept_" , format(report$CONCEPT_ID, scientific = FALSE) , ".json", sep='')
      write(jsonlite::toJSON(report), filename)
    },
    outputPath,
    reports
  )
}

generateAOPersonReport <- function(connectionDetails, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, outputPath)
{
  writeLines("Generating person report")
  output = {}
  conn <- DatabaseConnector::connect(connectionDetails)
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/person/population.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  personSummaryData <- DatabaseConnector::querySql(conn,renderedSql)
  output$SUMMARY = personSummaryData
  
  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/person/population_age_gender.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  ageGenderData <- DatabaseConnector::querySql(conn,renderedSql)
  output$AGE_GENDER_DATA = ageGenderData

  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/person/gender.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  genderData <- DatabaseConnector::querySql(conn,renderedSql)
  output$GENDER_DATA = genderData

  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/person/race.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  raceData <- DatabaseConnector::querySql(conn,renderedSql)
  output$RACE_DATA = raceData

  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/person/ethnicity.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  ethnicityData <- DatabaseConnector::querySql(conn,renderedSql)
  output$ETHNICITY_DATA = ethnicityData
  

  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/person/yearofbirth.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
                                                   warnOnMissingParameters = FALSE,
                                                   cdm_database_schema = cdmDatabaseSchema,
                                                   results_database_schema = resultsDatabaseSchema,
                                                   vocab_database_schema = vocabDatabaseSchema
  )
  birthYearData <- DatabaseConnector::querySql(conn,renderedSql)
  output$BIRTH_YEAR_DATA <- birthYearData
  
  jsonOutput = jsonlite::toJSON(output)
  write(jsonOutput, file=paste(outputPath, "/person.json", sep=""))
}

generateAOAchillesPerformanceReport <- function(connectionDetails, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, outputPath) 
{
  writeLines("Generating achilles performance report")

  queryAchillesPerformance <- SqlRender::loadRenderTranslateSql(sqlFilename = "export/performance/sqlAchillesPerformance.sql",
                                                                packageName = "Achilles",
                                                                dbms = connectionDetails$dbms,
                                                                warnOnMissingParameters = FALSE,
                                                                cdm_database_schema = cdmDatabaseSchema,
                                                                results_database_schema = resultsDatabaseSchema,
                                                                vocab_database_schema = vocabDatabaseSchema
  )  
  
  conn <- DatabaseConnector::connect(connectionDetails)
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  dataPerformance <- DatabaseConnector::querySql(conn,queryAchillesPerformance)
  names(dataPerformance) <- c("analysis_id", "analysis_name","category", "elapsed_seconds")
  dataPerformance$elapsed_seconds <- format(round(as.numeric(dataPerformance$elapsed_seconds),digits = 2),nsmall = 2)
  data.table::fwrite(dataPerformance, file.path(outputPath, "achilles-performance.csv"), scipen = 999)
}

generateAODeathReport <- function(connectionDetails, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, outputPath)
{
  writeLines("Generating death report")

  queryPrevalenceByGenderAgeYear <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/death/sqlPrevalenceByGenderAgeYear.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )  
  
  queryPrevalenceByMonth <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/death/sqlPrevalenceByMonth.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema
  )  

  queryDeathByType <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/death/sqlDeathByType.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryAgeAtDeath <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/death/sqlAgeAtDeath.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )  
  
  conn <- DatabaseConnector::connect(connectionDetails)
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  deathByTypeData <- DatabaseConnector::querySql(conn,queryDeathByType)
  prevalenceByGenderAgeYearData <- DatabaseConnector::querySql(conn,queryPrevalenceByGenderAgeYear)
  prevalenceByMonthData <- DatabaseConnector::querySql(conn,queryPrevalenceByMonth)
  ageAtDeathData <- DatabaseConnector::querySql(conn,queryAgeAtDeath)
  
  output = {}  
  output$PREVALENCE_BY_GENDER_AGE_YEAR = prevalenceByGenderAgeYearData  
  output$PREVALENCE_BY_MONTH = prevalenceByMonthData
  output$DEATH_BY_TYPE = deathByTypeData  
  output$AGE_AT_DEATH = ageAtDeathData
  
  filename <- file.path(outputPath, "death.json")  
  write(jsonlite::toJSON(output),filename)  
}

generateAOObservationPeriodReport <- function(connectionDetails, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, outputPath)
{
  writeLines("Generating observation period reports")
  conn <- DatabaseConnector::connect(connectionDetails)
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  output = {}
  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observationperiod/ageatfirst.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema
  )
  ageAtFirstObservationData <- DatabaseConnector::querySql(conn,renderedSql)
  output$AGE_AT_FIRST_OBSERVATION <- ageAtFirstObservationData
  
  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observationperiod/agebygender.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  ageByGenderData <- DatabaseConnector::querySql(conn,renderedSql)
  output$AGE_BY_GENDER = ageByGenderData

  observationLengthHist <- {}
  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observationperiod/observationlength_stats.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema
  )
  observationLengthStats <- DatabaseConnector::querySql(conn,renderedSql)
  observationLengthHist$MIN = observationLengthStats$MIN_VALUE
  observationLengthHist$MAX = observationLengthStats$MAX_VALUE
  observationLengthHist$INTERVAL_SIZE = observationLengthStats$INTERVAL_SIZE
  observationLengthHist$INTERVALS = (observationLengthStats$MAX_VALUE - observationLengthStats$MIN_VALUE) / observationLengthStats$INTERVAL_SIZE
  
  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observationperiod/observationlength_data.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema
  )
  observationLengthData <- DatabaseConnector::querySql(conn,renderedSql)
  output$OBSERVATION_LENGTH_HISTOGRAM = observationLengthHist

  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observationperiod/cumulativeduration.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema
  )
  cumulativeDurationData <- DatabaseConnector::querySql(conn,renderedSql)
  cumulativeDurationData$X_LENGTH_OF_OBSERVATION <- cumulativeDurationData$X_LENGTH_OF_OBSERVATION / 365.25
  cumulativeDurationData$SERIES_NAME <- NULL
  names(cumulativeDurationData) <- c("YEARS","PERCENT_PEOPLE")
  output$CUMULATIVE_DURATION = cumulativeDurationData

  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observationperiod/observationlengthbygender.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  opLengthByGenderData <- DatabaseConnector::querySql(conn,renderedSql)
  opLengthByGenderData$MIN_VALUE <- opLengthByGenderData$MIN_VALUE / 365.25
  opLengthByGenderData$P10_VALUE <- opLengthByGenderData$P10_VALUE / 365.25
  opLengthByGenderData$P25_VALUE <- opLengthByGenderData$P25_VALUE / 365.25
  opLengthByGenderData$MEDIAN_VALUE <- opLengthByGenderData$MEDIAN_VALUE / 365.25
  opLengthByGenderData$P75_VALUE <- opLengthByGenderData$P75_VALUE / 365.25
  opLengthByGenderData$P90_VALUE <- opLengthByGenderData$P90_VALUE / 365.25
  opLengthByGenderData$MAX_VALUE <- opLengthByGenderData$MAX_VALUE / 365.25
  
  output$OBSERVATION_PERIOD_LENGTH_BY_GENDER = opLengthByGenderData

  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observationperiod/observationlengthbyage.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema
  )
  opLengthByAgeData <- DatabaseConnector::querySql(conn,renderedSql)
  opLengthByAgeData$MIN_VALUE <- opLengthByAgeData$MIN_VALUE / 365.25
  opLengthByAgeData$P10_VALUE <- opLengthByAgeData$P10_VALUE / 365.25
  opLengthByAgeData$P25_VALUE <- opLengthByAgeData$P25_VALUE / 365.25
  opLengthByAgeData$MEDIAN_VALUE <- opLengthByAgeData$MEDIAN_VALUE / 365.25
  opLengthByAgeData$P75_VALUE <- opLengthByAgeData$P75_VALUE / 365.25
  opLengthByAgeData$P90_VALUE <- opLengthByAgeData$P90_VALUE / 365.25
  opLengthByAgeData$MAX_VALUE <- opLengthByAgeData$MAX_VALUE / 365.25
  output$OBSERVATION_PERIOD_LENGTH_BY_AGE = opLengthByAgeData

  observedByYearHist <- {}
  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observationperiod/observedbyyear_stats.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema
  )
  observedByYearStats <- DatabaseConnector::querySql(conn,renderedSql)
  observedByYearHist$MIN = observedByYearStats$MIN_VALUE
  observedByYearHist$MAX = observedByYearStats$MAX_VALUE
  observedByYearHist$INTERVAL_SIZE = observedByYearStats$INTERVAL_SIZE
  observedByYearHist$INTERVALS = (observedByYearStats$MAX_VALUE - observedByYearStats$MIN_VALUE) / observedByYearStats$INTERVAL_SIZE
  
  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observationperiod/observedbyyear_data.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema
  )
  observedByYearData <- DatabaseConnector::querySql(conn,renderedSql)
  observedByYearHist$DATA <- observedByYearData
  output$OBSERVED_BY_YEAR_HISTOGRAM = observedByYearHist
  
  observedByMonth <- {}
  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observationperiod/observedbymonth.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema
  )
  observedByMonth <- DatabaseConnector::querySql(conn,renderedSql)
  output$OBSERVED_BY_MONTH = observedByMonth

  renderedSql <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observationperiod/periodsperperson.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema
  )
  personPeriodsData <- DatabaseConnector::querySql(conn,renderedSql)
  output$PERSON_PERIODS_DATA = personPeriodsData
  
  filename <- file.path(outputPath, "observationperiod.json")
  write(jsonlite::toJSON(output),filename)  
}

generateAOVisitReports <- function(connectionDetails, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, outputPath)
{
  writeLines("Generating visit reports")
  
  queryVisits <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/visit/sqlVisitTreemap.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryPrevalenceByGenderAgeYear <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/visit/sqlPrevalenceByGenderAgeYear.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryPrevalenceByMonth <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/visit/sqlPrevalenceByMonth.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryVisitDurationByType <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/visit/sqlVisitDurationByType.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryAgeAtFirstOccurrence <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/visit/sqlAgeAtFirstOccurrence.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  conn <- DatabaseConnector::connect(connectionDetails)
  dataVisits <-  DatabaseConnector::querySql(conn,queryVisits) 
  names(dataVisits)[names(dataVisits) == 'CONCEPT_PATH'] <- 'CONCEPT_NAME'
  dataPrevalenceByGenderAgeYear <- DatabaseConnector::querySql(conn,queryPrevalenceByGenderAgeYear) 
  dataPrevalenceByMonth <- DatabaseConnector::querySql(conn,queryPrevalenceByMonth)  
  dataVisitDurationByType <- DatabaseConnector::querySql(conn,queryVisitDurationByType)    
  dataAgeAtFirstOccurrence <- DatabaseConnector::querySql(conn,queryAgeAtFirstOccurrence)    

  if (nrow(dataVisits) == 0) {
    return()
  }
  uniqueConcepts <- data.frame(
    CONCEPT_ID = unique(dataVisits$CONCEPT_ID),
    CDM_TABLE_NAME = "VISIT_OCCURRENCE"
  )
  reports <-
    uniqueConcepts %>%
    dplyr::left_join(
      (
        dataVisits %>%
        dplyr::select("CONCEPT_ID", "CONCEPT_NAME", "NUM_PERSONS", "PERCENT_PERSONS", "RECORDS_PER_PERSON")
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByGenderAgeYear %>%
        dplyr::select(c(1,3,4,5,6)) %>%
        tidyr::nest(PREVALENCE_BY_GENDER_AGE_YEAR = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByMonth %>%
        dplyr::select(c(1,3,4)) %>%
        tidyr::nest(PREVALENCE_BY_MONTH = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataVisitDurationByType %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(VISIT_DURATION_BY_TYPE = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataAgeAtFirstOccurrence %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(AGE_AT_FIRST_OCCURRENCE = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::collect()

  dir.create(paste0(outputPath,"/concepts/visit_occurrence"),recursive=T,showWarnings = F)
  x <- lapply(
    uniqueConcepts$CONCEPT_ID,
    function(concept_id, outputPath, reports) {
      report <- reports[reports$CONCEPT_ID == concept_id, ]
      report <- as.list(report)

      report$CONCEPT_NAME <- normalizeEmptyValue(report$CONCEPT_NAME)
      report$NUM_PERSONS <- normalizeEmptyValue(report$NUM_PERSONS)
      report$PERCENT_PERSONS <- normalizeEmptyValue(report$PERCENT_PERSONS)
      report$RECORDS_PER_PERSON <- normalizeEmptyValue(report$RECORDS_PER_PERSON)

      report$PREVALENCE_BY_GENDER_AGE_YEAR <- as.data.frame(report$PREVALENCE_BY_GENDER_AGE_YEAR)
      report$PREVALENCE_BY_MONTH <- as.data.frame(report$PREVALENCE_BY_MONTH)
      report$VISIT_DURATION_BY_TYPE <- as.data.frame(report$VISIT_DURATION_BY_TYPE)
      report$AGE_AT_FIRST_OCCURRENCE <- as.data.frame(report$AGE_AT_FIRST_OCCURRENCE)

      filename <- paste(outputPath, "/concepts/visit_occurrence/concept_" , format(report$CONCEPT_ID, scientific = FALSE) , ".json", sep='')
      write(jsonlite::toJSON(report), filename)
    },
    outputPath,
    reports
  )
}

generateAOVisitDetailReports <- function(connectionDetails, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, outputPath)
{
  writeLines("Generating visit_detail reports")
  
  queryVisitDetails <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/visitdetail/sqlVisitDetailTreemap.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryPrevalenceByGenderAgeYear <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/visitdetail/sqlPrevalenceByGenderAgeYear.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryPrevalenceByMonth <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/visitdetail/sqlPrevalenceByMonth.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryVisitDetailDurationByType <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/visitdetail/sqlVisitDetailDurationByType.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryAgeAtFirstOccurrence <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/visitdetail/sqlAgeAtFirstOccurrence.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  conn <- DatabaseConnector::connect(connectionDetails)
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  dataVisitDetails <- DatabaseConnector::querySql(conn,queryVisitDetails)
  names(dataVisitDetails)[names(dataVisitDetails) == 'CONCEPT_PATH'] <- 'CONCEPT_NAME'
  dataPrevalenceByGenderAgeYear <- DatabaseConnector::querySql(conn,queryPrevalenceByGenderAgeYear) 
  dataPrevalenceByMonth <- DatabaseConnector::querySql(conn,queryPrevalenceByMonth)  
  dataVisitDetailDurationByType <- DatabaseConnector::querySql(conn,queryVisitDetailDurationByType)    
  dataAgeAtFirstOccurrence <- DatabaseConnector::querySql(conn,queryAgeAtFirstOccurrence)    

  if (nrow(dataVisitDetails) == 0) {
    return()
  }
  uniqueConcepts <- data.frame(
    CONCEPT_ID = unique(dataVisitDetails$CONCEPT_ID),
    CDM_TABLE_NAME = "VISIT_DETAIL"
  )
  reports <-
    uniqueConcepts %>%
    dplyr::left_join(
      (
        dataVisitDetails %>%
        dplyr::select("CONCEPT_ID", "CONCEPT_NAME", "NUM_PERSONS", "PERCENT_PERSONS", "RECORDS_PER_PERSON")
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByGenderAgeYear %>%
        dplyr::select(c(1,3,4,5,6)) %>%
        tidyr::nest(PREVALENCE_BY_GENDER_AGE_YEAR = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByMonth %>%
        dplyr::select(c(1,3,4)) %>%
        tidyr::nest(PREVALENCE_BY_MONTH = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataVisitDetailDurationByType %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(VISIT_DETAIL_DURATION_BY_TYPE = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataAgeAtFirstOccurrence %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(AGE_AT_FIRST_OCCURRENCE = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::collect()

  dir.create(paste0(outputPath,"/concepts/visit_detail"),recursive=T,showWarnings = F)
  x <- lapply(
    uniqueConcepts$CONCEPT_ID,
    function(concept_id, outputPath, reports) {
      report <- reports[reports$CONCEPT_ID == concept_id, ]
      report <- as.list(report)

      report$CONCEPT_NAME <- normalizeEmptyValue(report$CONCEPT_NAME)
      report$NUM_PERSONS <- normalizeEmptyValue(report$NUM_PERSONS)
      report$PERCENT_PERSONS <- normalizeEmptyValue(report$PERCENT_PERSONS)
      report$RECORDS_PER_PERSON <- normalizeEmptyValue(report$RECORDS_PER_PERSON)

      report$PREVALENCE_BY_GENDER_AGE_YEAR <- as.data.frame(report$PREVALENCE_BY_GENDER_AGE_YEAR)
      report$PREVALENCE_BY_MONTH <- as.data.frame(report$PREVALENCE_BY_MONTH)
      report$VISIT_DETAIL_DURATION_BY_TYPE <- as.data.frame(report$VISIT_DETAIL_DURATION_BY_TYPE)
      report$AGE_AT_FIRST_OCCURRENCE <- as.data.frame(report$AGE_AT_FIRST_OCCURRENCE)

      filename <- paste(outputPath, "/concepts/visit_detail/concept_" , format(report$CONCEPT_ID, scientific = FALSE) , ".json", sep='')
      write(jsonlite::toJSON(report), filename)
    },
    outputPath,
    reports
  )
}

generateAOMetadataReport <- function(connectionDetails, cdmDatabaseSchema, outputPath)
{
  conn <- DatabaseConnector::connect(connectionDetails)
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  if (DatabaseConnector::existsTable(connection = conn, databaseSchema = cdmDatabaseSchema, tableName = "METADATA"))
  {
    writeLines("Generating metadata report")    
    queryMetadata <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/metadata/sqlMetadata.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      cdm_database_schema = cdmDatabaseSchema
    )      
    dataMetadata <- DatabaseConnector::querySql(conn, queryMetadata) 
    data.table::fwrite(dataMetadata, file=paste0(outputPath, "/metadata.csv"), scipen = 999)
  }
}

generateAOObservationReports <- function(connectionDetails, observationsData, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, outputPath)
{
  writeLines("Generating Observation reports")

  queryPrevalenceByGenderAgeYear <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observation/sqlPrevalenceByGenderAgeYear.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryPrevalenceByMonth <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observation/sqlPrevalenceByMonth.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryObsFrequencyDistribution <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observation/sqlFrequencyDistribution.sql", 
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryObservationsByType <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observation/sqlObservationsByType.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryAgeAtFirstOccurrence <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/observation/sqlAgeAtFirstOccurrence.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  conn <- DatabaseConnector::connect(connectionDetails)  
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  dataPrevalenceByGenderAgeYear <- DatabaseConnector::querySql(conn,queryPrevalenceByGenderAgeYear) 
  dataPrevalenceByMonth <- DatabaseConnector::querySql(conn,queryPrevalenceByMonth)  
  dataObservationsByType <- DatabaseConnector::querySql(conn,queryObservationsByType)    
  dataAgeAtFirstOccurrence <- DatabaseConnector::querySql(conn,queryAgeAtFirstOccurrence)
  dataObsFrequencyDistribution <- DatabaseConnector::querySql(conn,queryObsFrequencyDistribution)

  if (nrow(observationsData) == 0) {
    return()
  }
  uniqueConcepts <- data.frame(
    CONCEPT_ID = unique(observationsData$CONCEPT_ID),
    CDM_TABLE_NAME = "OBSERVATION"
  )
  reports <-
    uniqueConcepts %>%
    dplyr::left_join(
      observationsData,
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::select("CONCEPT_ID", "CONCEPT_NAME", "CDM_TABLE_NAME", "NUM_PERSONS", "PERCENT_PERSONS", "RECORDS_PER_PERSON") %>%
    dplyr::left_join(
      (
        dataPrevalenceByGenderAgeYear %>%
        dplyr::select(c(1,3,4,5,6)) %>%
        tidyr::nest(PREVALENCE_BY_GENDER_AGE_YEAR = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByMonth %>%
        dplyr::select(c(1,3,4)) %>%
        tidyr::nest(PREVALENCE_BY_MONTH = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataObsFrequencyDistribution %>%
        dplyr::select(c(1,3,4)) %>%
        tidyr::nest(OBS_FREQUENCY_DISTRIBUTION = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataObservationsByType %>%
        dplyr::select(c(1,4,5)) %>%
        tidyr::nest(OBSERVATIONS_BY_TYPE = c(-1))
      ),
      by = c("CONCEPT_ID" = "OBSERVATION_CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataAgeAtFirstOccurrence %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(AGE_AT_FIRST_OCCURRENCE = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::collect()

  dir.create(paste0(outputPath,"/concepts/observation"),recursive=T,showWarnings = F)
  x <- lapply(
    uniqueConcepts$CONCEPT_ID,
    function(concept_id, outputPath, reports) {
      report <- reports[reports$CONCEPT_ID == concept_id, ]
      report <- as.list(report)

      report$CONCEPT_NAME <- normalizeEmptyValue(report$CONCEPT_NAME)
      report$NUM_PERSONS <- normalizeEmptyValue(report$NUM_PERSONS)
      report$PERCENT_PERSONS <- normalizeEmptyValue(report$PERCENT_PERSONS)
      report$RECORDS_PER_PERSON <- normalizeEmptyValue(report$RECORDS_PER_PERSON)

      report$PREVALENCE_BY_GENDER_AGE_YEAR <- as.data.frame(report$PREVALENCE_BY_GENDER_AGE_YEAR)
      report$PREVALENCE_BY_MONTH <- as.data.frame(report$PREVALENCE_BY_MONTH)
      report$OBS_FREQUENCY_DISTRIBUTION <- as.data.frame(report$OBS_FREQUENCY_DISTRIBUTION)
      report$OBSERVATIONS_BY_TYPE <- as.data.frame(report$OBSERVATIONS_BY_TYPE)
      report$AGE_AT_FIRST_OCCURRENCE <- as.data.frame(report$AGE_AT_FIRST_OCCURRENCE)

      filename <- paste(outputPath, "/concepts/observation/concept_" , format(report$CONCEPT_ID, scientific = FALSE) , ".json", sep='')
      write(jsonlite::toJSON(report), filename)
    },
    outputPath,
    reports
  )
}

generateAOCdmSourceReport <- function(connectionDetails, cdmDatabaseSchema, outputPath)
{
  conn <- DatabaseConnector::connect(connectionDetails)  
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  if (DatabaseConnector::existsTable(connection = conn, databaseSchema = cdmDatabaseSchema, tableName = "CDM_SOURCE"))
  {
    writeLines("Generating cdm source report")    
    queryCdmSource <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/metadata/sqlCdmSource.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      cdm_database_schema = cdmDatabaseSchema
    )  
    
    dataCdmSource <- DatabaseConnector::querySql(conn, queryCdmSource) 
    data.table::fwrite(dataCdmSource, file=paste0(outputPath, "/cdmsource.csv"), scipen = 999)
  }
}

generateAODashboardReport <- function(outputPath)
{
  output <- {}
  personReport <- jsonlite::fromJSON(file = paste(outputPath, "/person.json", sep=""))
  output$SUMMARY <- personReport$SUMMARY
  output$GENDER_DATA <- personReport$GENDER_DATA
  opReport <- jsonlite::fromJSON(file = paste(outputPath, "/observationperiod.json", sep=""))
  
  output$AGE_AT_FIRST_OBSERVATION_HISTOGRAM <- opReport$AGE_AT_FIRST_OBSERVATION_HISTOGRAM
  output$CUMULATIVE_DURATION <- opReport$CUMULATIVE_DURATION
  output$OBSERVED_BY_MONTH <- opReport$OBSERVED_BY_MONTH

  jsonOutput <- jsonlite::toJSON(output)
  write(jsonOutput, file=paste(outputPath, "/dashboard.json", sep=""))  
}

generateAOMeasurementReports <- function(connectionDetails, dataMeasurements, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, outputPath)
{
  writeLines("Generating Measurement reports")
  queryPrevalenceByGenderAgeYear <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/measurement/sqlPrevalenceByGenderAgeYear.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryPrevalenceByMonth <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/measurement/sqlPrevalenceByMonth.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryFrequencyDistribution <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/measurement/sqlFrequencyDistribution.sql", 
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryMeasurementsByType <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/measurement/sqlMeasurementsByType.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryAgeAtFirstOccurrence <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/measurement/sqlAgeAtFirstOccurrence.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryRecordsByUnit <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/measurement/sqlRecordsByUnit.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryMeasurementValueDistribution <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/measurement/sqlMeasurementValueDistribution.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryLowerLimitDistribution <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/measurement/sqlLowerLimitDistribution.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryUpperLimitDistribution <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/measurement/sqlUpperLimitDistribution.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryValuesRelativeToNorm <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/measurement/sqlValuesRelativeToNorm.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  conn <- DatabaseConnector::connect(connectionDetails)
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  dataPrevalenceByGenderAgeYear <- DatabaseConnector::querySql(conn,queryPrevalenceByGenderAgeYear) 
  dataPrevalenceByMonth <- DatabaseConnector::querySql(conn,queryPrevalenceByMonth)  
  dataMeasurementsByType <- DatabaseConnector::querySql(conn,queryMeasurementsByType)    
  dataAgeAtFirstOccurrence <- DatabaseConnector::querySql(conn,queryAgeAtFirstOccurrence)
  dataRecordsByUnit <- DatabaseConnector::querySql(conn,queryRecordsByUnit)
  dataMeasurementValueDistribution <- DatabaseConnector::querySql(conn,queryMeasurementValueDistribution)
  dataLowerLimitDistribution <- DatabaseConnector::querySql(conn,queryLowerLimitDistribution)
  dataUpperLimitDistribution <- DatabaseConnector::querySql(conn,queryUpperLimitDistribution)
  dataValuesRelativeToNorm <- DatabaseConnector::querySql(conn,queryValuesRelativeToNorm)
  dataFrequencyDistribution <- DatabaseConnector::querySql(conn,queryFrequencyDistribution)

  if (nrow(dataPrevalenceByMonth) == 0) {
    return()
  }
  uniqueConcepts <- data.frame(
    CONCEPT_ID = unique(dataPrevalenceByMonth$CONCEPT_ID),
    CDM_TABLE_NAME = "MEASUREMENT"
  )
  reports <-
    uniqueConcepts %>%
    dplyr::left_join(
      (
        dataMeasurements %>%
        dplyr::select("CONCEPT_ID", "CONCEPT_NAME", "NUM_PERSONS", "PERCENT_PERSONS", "RECORDS_PER_PERSON")
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByGenderAgeYear %>%
        dplyr::select(c(1,3,4,5,6)) %>%
        tidyr::nest(PREVALENCE_BY_GENDER_AGE_YEAR = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByMonth %>%
        dplyr::select(c(1,3,4)) %>%
        tidyr::nest(PREVALENCE_BY_MONTH = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataFrequencyDistribution %>%
        dplyr::select(c(1,3,4)) %>%
        tidyr::nest(FREQUENCY_DISTRIBUTION = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataMeasurementsByType %>%
        dplyr::select(c(1,4,5)) %>%
        tidyr::nest(MEASUREMENTS_BY_TYPE = c(-1))
      ),
      by = c("CONCEPT_ID" = "MEASUREMENT_CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataAgeAtFirstOccurrence %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(AGE_AT_FIRST_OCCURRENCE = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataRecordsByUnit %>%
        dplyr::select(c(1,4,5)) %>%
        tidyr::nest(RECORDS_BY_UNIT = c(-1))
      ),
      by = c("CONCEPT_ID" = "MEASUREMENT_CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataMeasurementValueDistribution %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(MEASUREMENT_VALUE_DISTRIBUTION = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataLowerLimitDistribution %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(LOWER_LIMIT_DISTRIBUTION = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataUpperLimitDistribution %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(UPPER_LIMIT_DISTRIBUTION = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataValuesRelativeToNorm %>%
        dplyr::select(c(1,4,5)) %>%
        tidyr::nest(VALUES_RELATIVE_TO_NORM = c(-1))
      ),
      by = c("CONCEPT_ID" = "MEASUREMENT_CONCEPT_ID")
    ) %>%
    dplyr::collect()

  dir.create(paste0(outputPath,"/concepts/measurement"),recursive=T,showWarnings = F)
  x <- lapply(
    uniqueConcepts$CONCEPT_ID,
    function(concept_id, outputPath, reports) {
      report <- reports[reports$CONCEPT_ID == concept_id, ]
      report <- as.list(report)

      report$CONCEPT_NAME <- normalizeEmptyValue(report$CONCEPT_NAME)
      report$NUM_PERSONS <- normalizeEmptyValue(report$NUM_PERSONS)
      report$PERCENT_PERSONS <- normalizeEmptyValue(report$PERCENT_PERSONS)
      report$RECORDS_PER_PERSON <- normalizeEmptyValue(report$RECORDS_PER_PERSON)

      report$PREVALENCE_BY_GENDER_AGE_YEAR <- as.data.frame(report$PREVALENCE_BY_GENDER_AGE_YEAR)
      report$PREVALENCE_BY_MONTH <- as.data.frame(report$PREVALENCE_BY_MONTH)
      report$FREQUENCY_DISTRIBUTION <- as.data.frame(report$FREQUENCY_DISTRIBUTION)
      report$MEASUREMENTS_BY_TYPE <- as.data.frame(report$MEASUREMENTS_BY_TYPE)
      report$AGE_AT_FIRST_OCCURRENCE <- as.data.frame(report$AGE_AT_FIRST_OCCURRENCE)
      report$RECORDS_BY_UNIT <- as.data.frame(report$RECORDS_BY_UNIT)
      report$MEASUREMENT_VALUE_DISTRIBUTION <- as.data.frame(report$MEASUREMENT_VALUE_DISTRIBUTION)
      report$LOWER_LIMIT_DISTRIBUTION <- as.data.frame(report$LOWER_LIMIT_DISTRIBUTION)
      report$UPPER_LIMIT_DISTRIBUTION <- as.data.frame(report$UPPER_LIMIT_DISTRIBUTION)
      report$VALUES_RELATIVE_TO_NORM <- as.data.frame(report$VALUES_RELATIVE_TO_NORM)

      filename <- paste(outputPath, "/concepts/measurement/concept_" , format(report$CONCEPT_ID, scientific = FALSE) , ".json", sep='')
      write(jsonlite::toJSON(report), filename)
    },
    outputPath,
    reports
  )
}

generateAODrugEraReports <- function(connectionDetails, dataDrugEra, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, outputPath) 
{
  writeLines("Generating drug era reports")

  queryAgeAtFirstExposure <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/drugera/sqlAgeAtFirstExposure.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryPrevalenceByGenderAgeYear <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/drugera/sqlPrevalenceByGenderAgeYear.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryPrevalenceByMonth <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/drugera/sqlPrevalenceByMonth.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryLengthOfEra <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/drugera/sqlLengthOfEra.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )

  conn <- DatabaseConnector::connect(connectionDetails)  
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  dataAgeAtFirstExposure <- DatabaseConnector::querySql(conn,queryAgeAtFirstExposure) 
  dataPrevalenceByGenderAgeYear <- DatabaseConnector::querySql(conn,queryPrevalenceByGenderAgeYear) 
  dataPrevalenceByMonth <- DatabaseConnector::querySql(conn,queryPrevalenceByMonth)
  dataLengthOfEra <- DatabaseConnector::querySql(conn,queryLengthOfEra)

  if (nrow(dataDrugEra) == 0) {
    return()
  }
  uniqueConcepts <- data.frame(
    CONCEPT_ID = unique(dataDrugEra$CONCEPT_ID),
    CDM_TABLE_NAME = "DRUG_ERA"
  )
  reports <-
    uniqueConcepts %>%
    dplyr::left_join(
      (
        dataDrugEra %>%
        dplyr::select("CONCEPT_ID", "CONCEPT_NAME", "NUM_PERSONS", "PERCENT_PERSONS", "RECORDS_PER_PERSON")
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataAgeAtFirstExposure %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(AGE_AT_FIRST_EXPOSURE = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByGenderAgeYear %>%
        dplyr::select(c(1,2,3,4,5)) %>%
        tidyr::nest(PREVALENCE_BY_GENDER_AGE_YEAR = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByMonth %>%
        dplyr::select(c(1,2,3)) %>%
        tidyr::nest(PREVALENCE_BY_MONTH = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataLengthOfEra %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(LENGTH_OF_ERA = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::collect()

  dir.create(paste0(outputPath,"/concepts/drug_era"),recursive=T,showWarnings = F)
  x <- lapply(
    uniqueConcepts$CONCEPT_ID,
    function(concept_id, outputPath, reports) {
      report <- reports[reports$CONCEPT_ID == concept_id, ]
      report <- as.list(report)

      report$CONCEPT_NAME <- normalizeEmptyValue(report$CONCEPT_NAME)
      report$NUM_PERSONS <- normalizeEmptyValue(report$NUM_PERSONS)
      report$PERCENT_PERSONS <- normalizeEmptyValue(report$PERCENT_PERSONS)
      report$RECORDS_PER_PERSON <- normalizeEmptyValue(report$RECORDS_PER_PERSON)

      report$AGE_AT_FIRST_EXPOSURE <- as.data.frame(report$AGE_AT_FIRST_EXPOSURE)
      report$PREVALENCE_BY_GENDER_AGE_YEAR <- as.data.frame(report$PREVALENCE_BY_GENDER_AGE_YEAR)
      report$PREVALENCE_BY_MONTH <- as.data.frame(report$PREVALENCE_BY_MONTH)
      report$LENGTH_OF_ERA <- as.data.frame(report$LENGTH_OF_ERA)

      filename <- paste(outputPath, "/concepts/drug_era/concept_" , format(report$CONCEPT_ID, scientific = FALSE) , ".json", sep='')
      write(jsonlite::toJSON(report), filename)
    },
    outputPath,
    reports
  )
}

generateAODrugReports <- function(connectionDetails, dataDrugs, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, outputPath) 
{
  writeLines("Generating drug reports")
  
  queryAgeAtFirstExposure <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/drug/sqlAgeAtFirstExposure.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryDaysSupplyDistribution <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/drug/sqlDaysSupplyDistribution.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryDrugsByType <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/drug/sqlDrugsByType.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryPrevalenceByGenderAgeYear <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/drug/sqlPrevalenceByGenderAgeYear.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryPrevalenceByMonth <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/drug/sqlPrevalenceByMonth.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryDrugFrequencyDistribution <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/drug/sqlFrequencyDistribution.sql", 
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryQuantityDistribution <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/drug/sqlQuantityDistribution.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryRefillsDistribution <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/drug/sqlRefillsDistribution.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  conn <- DatabaseConnector::connect(connectionDetails)  
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  dataAgeAtFirstExposure <- DatabaseConnector::querySql(conn,queryAgeAtFirstExposure) 
  dataDaysSupplyDistribution <- DatabaseConnector::querySql(conn,queryDaysSupplyDistribution) 
  dataDrugsByType <- DatabaseConnector::querySql(conn,queryDrugsByType) 
  dataPrevalenceByGenderAgeYear <- DatabaseConnector::querySql(conn,queryPrevalenceByGenderAgeYear) 
  dataPrevalenceByMonth <- DatabaseConnector::querySql(conn,queryPrevalenceByMonth)
  dataQuantityDistribution <- DatabaseConnector::querySql(conn,queryQuantityDistribution) 
  dataRefillsDistribution <- DatabaseConnector::querySql(conn,queryRefillsDistribution) 
  dataDrugFrequencyDistribution <- DatabaseConnector::querySql(conn,queryDrugFrequencyDistribution)

  if (nrow(dataPrevalenceByMonth) == 0) {
    return()
  }
  uniqueConcepts <- data.frame(
    CONCEPT_ID = unique(dataPrevalenceByMonth$CONCEPT_ID),
    CDM_TABLE_NAME = "DRUG_EXPOSURE"
  )
  reports <-
    uniqueConcepts %>%
    dplyr::left_join(
      (
        dataDrugs %>%
        dplyr::select("CONCEPT_ID", "CONCEPT_NAME", "NUM_PERSONS", "PERCENT_PERSONS", "RECORDS_PER_PERSON")
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataAgeAtFirstExposure %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(AGE_AT_FIRST_EXPOSURE = c(-1))
      ),
      by = c("CONCEPT_ID" = "DRUG_CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataDaysSupplyDistribution %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(DAYS_SUPPLY_DISTRIBUTION = c(-1))
      ),
      by = c("CONCEPT_ID" = "DRUG_CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataDrugsByType %>%
        dplyr::select(c(1,3,4)) %>%
        tidyr::nest(DRUGS_BY_TYPE = c(-1))
      ),
      by = c("CONCEPT_ID" = "DRUG_CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByGenderAgeYear %>%
        dplyr::select(c(1,3,4,5,6)) %>%
        tidyr::nest(PREVALENCE_BY_GENDER_AGE_YEAR = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByMonth %>%
        dplyr::select(c(1,3,4)) %>%
        tidyr::nest(PREVALENCE_BY_MONTH = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataDrugFrequencyDistribution %>%
        dplyr::select(c(1,3,4)) %>%
        tidyr::nest(DRUG_FREQUENCY_DISTRIBUTION = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataQuantityDistribution %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(QUANTITY_DISTRIBUTION = c(-1))
      ),
      by = c("CONCEPT_ID" = "DRUG_CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataRefillsDistribution %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(REFILLS_DISTRIBUTION = c(-1))
      ),
      by = c("CONCEPT_ID" = "DRUG_CONCEPT_ID")
    ) %>%
    dplyr::collect()

  dir.create(paste0(outputPath,"/concepts/drug_exposure"),recursive=T,showWarnings = F)
  x <- lapply(
    uniqueConcepts$CONCEPT_ID,
    function(concept_id, outputPath, reports) {
      report <- reports[reports$CONCEPT_ID == concept_id, ]
      report <- as.list(report)

      report$CONCEPT_NAME <- normalizeEmptyValue(report$CONCEPT_NAME)
      report$NUM_PERSONS <- normalizeEmptyValue(report$NUM_PERSONS)
      report$PERCENT_PERSONS <- normalizeEmptyValue(report$PERCENT_PERSONS)
      report$RECORDS_PER_PERSON <- normalizeEmptyValue(report$RECORDS_PER_PERSON)

      report$AGE_AT_FIRST_EXPOSURE <- as.data.frame(report$AGE_AT_FIRST_EXPOSURE)
      report$DAYS_SUPPLY_DISTRIBUTION <- as.data.frame(report$DAYS_SUPPLY_DISTRIBUTION)
      report$DRUGS_BY_TYPE <- as.data.frame(report$DRUGS_BY_TYPE)
      report$PREVALENCE_BY_GENDER_AGE_YEAR <- as.data.frame(report$PREVALENCE_BY_GENDER_AGE_YEAR)
      report$PREVALENCE_BY_MONTH <- as.data.frame(report$PREVALENCE_BY_MONTH)
      report$DRUG_FREQUENCY_DISTRIBUTION <- as.data.frame(report$DRUG_FREQUENCY_DISTRIBUTION)
      report$QUANTITY_DISTRIBUTION <- as.data.frame(report$QUANTITY_DISTRIBUTION)
      report$REFILLS_DISTRIBUTION <- as.data.frame(report$REFILLS_DISTRIBUTION)

      filename <- paste(outputPath, "/concepts/drug_exposure/concept_" , format(report$CONCEPT_ID, scientific = FALSE) , ".json", sep='')
      write(jsonlite::toJSON(report), filename)
    },
    outputPath,
    reports
  )
}

generateAODeviceReports <- function(connectionDetails, dataDevices, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, outputPath) 
{
  writeLines("Generating device exposure reports")
  
  queryAgeAtFirstExposure <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/device/sqlAgeAtFirstExposure.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )

  queryDevicesByType <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/device/sqlDevicesByType.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryPrevalenceByGenderAgeYear <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/device/sqlPrevalenceByGenderAgeYear.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryPrevalenceByMonth <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/device/sqlPrevalenceByMonth.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryDeviceFrequencyDistribution <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/device/sqlFrequencyDistribution.sql", 
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )

  conn <- DatabaseConnector::connect(connectionDetails)  
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  dataAgeAtFirstExposure <- DatabaseConnector::querySql(conn,queryAgeAtFirstExposure) 
  dataDevicesByType <- DatabaseConnector::querySql(conn,queryDevicesByType) 
  dataPrevalenceByGenderAgeYear <- DatabaseConnector::querySql(conn,queryPrevalenceByGenderAgeYear) 
  dataPrevalenceByMonth <- DatabaseConnector::querySql(conn,queryPrevalenceByMonth)
  dataDeviceFrequencyDistribution <- DatabaseConnector::querySql(conn,queryDeviceFrequencyDistribution)

  if (nrow(dataDevices) == 0) {
    return()
  }
  uniqueConcepts <- data.frame(
    CONCEPT_ID = unique(dataDevices$CONCEPT_ID),
    CDM_TABLE_NAME = "DEVICE_EXPOSURE"
  )
  reports <-
    uniqueConcepts %>%
    dplyr::left_join(
      (
        dataDevices %>%
        dplyr::select("CONCEPT_ID", "CONCEPT_NAME", "NUM_PERSONS", "PERCENT_PERSONS", "RECORDS_PER_PERSON")
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataAgeAtFirstExposure %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(AGE_AT_FIRST_EXPOSURE = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataDevicesByType %>%
        dplyr::select(c(1,4,5)) %>%
        tidyr::nest(DEVICES_BY_TYPE = c(-1))
      ),
      by = c("CONCEPT_ID" = "DEVICE_CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByGenderAgeYear %>%
        dplyr::select(c(1,3,4,5,6)) %>%
        tidyr::nest(PREVALENCE_BY_GENDER_AGE_YEAR = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByMonth %>%
        dplyr::select(c(1,3,4)) %>%
        tidyr::nest(PREVALENCE_BY_MONTH = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataDeviceFrequencyDistribution %>%
        dplyr::select(c(1,3,4)) %>%
        tidyr::nest(DEVICE_FREQUENCY_DISTRIBUTION = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::collect()

  dir.create(paste0(outputPath,"/concepts/device_exposure"),recursive=T,showWarnings = F)
  x <- lapply(
    uniqueConcepts$CONCEPT_ID,
    function(concept_id, outputPath, reports) {
      report <- reports[reports$CONCEPT_ID == concept_id, ]
      report <- as.list(report)

      report$CONCEPT_NAME <- normalizeEmptyValue(report$CONCEPT_NAME)
      report$NUM_PERSONS <- normalizeEmptyValue(report$NUM_PERSONS)
      report$PERCENT_PERSONS <- normalizeEmptyValue(report$PERCENT_PERSONS)
      report$RECORDS_PER_PERSON <- normalizeEmptyValue(report$RECORDS_PER_PERSON)

      report$AGE_AT_FIRST_EXPOSURE <- as.data.frame(report$AGE_AT_FIRST_EXPOSURE)
      report$DEVICES_BY_TYPE <- as.data.frame(report$DEVICES_BY_TYPE)
      report$PREVALENCE_BY_GENDER_AGE_YEAR <- as.data.frame(report$PREVALENCE_BY_GENDER_AGE_YEAR)
      report$PREVALENCE_BY_MONTH <- as.data.frame(report$PREVALENCE_BY_MONTH)
      report$DEVICE_FREQUENCY_DISTRIBUTION <- as.data.frame(report$DEVICE_FREQUENCY_DISTRIBUTION)

      filename <- paste(outputPath, "/concepts/device_exposure/concept_" , format(report$CONCEPT_ID, scientific = FALSE) , ".json", sep='')
      write(jsonlite::toJSON(report), filename)
    },
    outputPath,
    reports
  )
}

generateAOConditionReports <- function(connectionDetails, dataConditions, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, outputPath) 
{
  writeLines("Generating condition reports")
  queryPrevalenceByGenderAgeYear <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/condition/sqlPrevalenceByGenderAgeYear.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryPrevalenceByMonth <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/condition/sqlPrevalenceByMonth.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryConditionsByType <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/condition/sqlConditionsByType.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryAgeAtFirstDiagnosis <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/condition/sqlAgeAtFirstDiagnosis.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  conn <- DatabaseConnector::connect(connectionDetails)
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  dataPrevalenceByGenderAgeYear <- DatabaseConnector::querySql(conn,queryPrevalenceByGenderAgeYear) 
  dataPrevalenceByMonth <- DatabaseConnector::querySql(conn,queryPrevalenceByMonth)  
  dataConditionsByType <- DatabaseConnector::querySql(conn,queryConditionsByType)    
  dataAgeAtFirstDiagnosis <- DatabaseConnector::querySql(conn,queryAgeAtFirstDiagnosis)      

  if (nrow(dataPrevalenceByMonth) == 0) {
    return()
  }
  uniqueConcepts <- data.frame(
    CONCEPT_ID = unique(dataPrevalenceByMonth$CONCEPT_ID),
    CDM_TABLE_NAME = "CONDITION_OCCURRENCE"
  )
  reports <-
    uniqueConcepts %>%
    dplyr::left_join(
      (
        dataConditions %>%
        dplyr::select("CONCEPT_ID", "CONCEPT_NAME", "NUM_PERSONS", "PERCENT_PERSONS", "RECORDS_PER_PERSON")
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByGenderAgeYear %>%
        dplyr::select(c(1,3,4,5,6)) %>%
        tidyr::nest(PREVALENCE_BY_GENDER_AGE_YEAR = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByMonth %>%
        dplyr::select(c(1,3,4)) %>%
        tidyr::nest(PREVALENCE_BY_MONTH = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataConditionsByType %>%
        dplyr::select(c(1,2,3)) %>%
        tidyr::nest(CONDITIONS_BY_TYPE = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONDITION_CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataAgeAtFirstDiagnosis %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(AGE_AT_FIRST_DIAGNOSIS = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::collect()

  dir.create(paste0(outputPath,"/concepts/condition_occurrence"),recursive=T,showWarnings = F)
  x <- lapply(
    uniqueConcepts$CONCEPT_ID,
    function(concept_id, outputPath, reports) {
      report <- reports[reports$CONCEPT_ID == concept_id, ]
      report <- as.list(report)

      report$CONCEPT_NAME <- normalizeEmptyValue(report$CONCEPT_NAME)
      report$NUM_PERSONS <- normalizeEmptyValue(report$NUM_PERSONS)
      report$PERCENT_PERSONS <- normalizeEmptyValue(report$PERCENT_PERSONS)
      report$RECORDS_PER_PERSON <- normalizeEmptyValue(report$RECORDS_PER_PERSON)

      report$PREVALENCE_BY_GENDER_AGE_YEAR <- as.data.frame(report$PREVALENCE_BY_GENDER_AGE_YEAR)
      report$PREVALENCE_BY_MONTH <- as.data.frame(report$PREVALENCE_BY_MONTH)
      report$CONDITIONS_BY_TYPE <- as.data.frame(report$CONDITIONS_BY_TYPE)
      report$AGE_AT_FIRST_DIAGNOSIS <- as.data.frame(report$AGE_AT_FIRST_DIAGNOSIS)

      filename <- paste(outputPath, "/concepts/condition_occurrence/concept_" , format(report$CONCEPT_ID, scientific = FALSE) , ".json", sep='')
      write(jsonlite::toJSON(report), filename)
    },
    outputPath,
    reports
  )
}

generateAOConditionEraReports <- function(connectionDetails, dataConditionEra, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, outputPath)
{
  writeLines("Generating condition era reports")

  queryPrevalenceByGenderAgeYear <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/conditionera/sqlPrevalenceByGenderAgeYear.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryPrevalenceByMonth <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/conditionera/sqlPrevalenceByMonth.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryAgeAtFirstDiagnosis <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/conditionera/sqlAgeAtFirstDiagnosis.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  queryLengthOfEra <- SqlRender::loadRenderTranslateSql(
    sqlFilename = "export/conditionera/sqlLengthOfEra.sql",
    packageName = "Achilles",
    dbms = connectionDetails$dbms,
    warnOnMissingParameters = FALSE,
    cdm_database_schema = cdmDatabaseSchema,
    results_database_schema = resultsDatabaseSchema,
    vocab_database_schema = vocabDatabaseSchema
  )
  
  conn <- DatabaseConnector::connect(connectionDetails)  
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  dataPrevalenceByGenderAgeYear <- DatabaseConnector::querySql(conn, queryPrevalenceByGenderAgeYear)
  dataPrevalenceByMonth <- DatabaseConnector::querySql(conn, queryPrevalenceByMonth)
  dataLengthOfEra <- DatabaseConnector::querySql(conn, queryLengthOfEra)
  dataAgeAtFirstDiagnosis <- DatabaseConnector::querySql(conn, queryAgeAtFirstDiagnosis)

  if (nrow(dataConditionEra) == 0) {
    return()
  }
  uniqueConcepts <- data.frame(
    CONCEPT_ID = unique(dataConditionEra$CONCEPT_ID),
    CDM_TABLE_NAME = "CONDITION_ERA"
  )
  reports <-
    uniqueConcepts %>%
    dplyr::left_join(
      (
        dataConditionEra %>%
        dplyr::select("CONCEPT_ID", "CONCEPT_NAME", "NUM_PERSONS", "PERCENT_PERSONS", "RECORDS_PER_PERSON")
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataAgeAtFirstDiagnosis %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(AGE_AT_FIRST_EXPOSURE = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByGenderAgeYear %>%
        dplyr::select(c(1,2,3,4,5)) %>%
        tidyr::nest(PREVALENCE_BY_GENDER_AGE_YEAR = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataPrevalenceByMonth %>%
        dplyr::select(c(1,2,3)) %>%
        tidyr::nest(PREVALENCE_BY_MONTH = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::left_join(
      (
        dataLengthOfEra %>%
        dplyr::select(c(1,2,3,4,5,6,7,8,9)) %>%
        tidyr::nest(LENGTH_OF_ERA = c(-1))
      ),
      by = c("CONCEPT_ID" = "CONCEPT_ID")
    ) %>%
    dplyr::collect()

  dir.create(paste0(outputPath,"/concepts/condition_era"),recursive=T,showWarnings = F)
  x <- lapply(
    uniqueConcepts$CONCEPT_ID,
    function(concept_id, outputPath, reports) {
      report <- reports[reports$CONCEPT_ID == concept_id, ]
      report <- as.list(report)

      report$CONCEPT_NAME <- normalizeEmptyValue(report$CONCEPT_NAME)
      report$NUM_PERSONS <- normalizeEmptyValue(report$NUM_PERSONS)
      report$PERCENT_PERSONS <- normalizeEmptyValue(report$PERCENT_PERSONS)
      report$RECORDS_PER_PERSON <- normalizeEmptyValue(report$RECORDS_PER_PERSON)

      report$AGE_AT_FIRST_EXPOSURE <- as.data.frame(report$AGE_AT_FIRST_EXPOSURE)
      report$PREVALENCE_BY_GENDER_AGE_YEAR <- as.data.frame(report$PREVALENCE_BY_GENDER_AGE_YEAR)
      report$PREVALENCE_BY_MONTH <- as.data.frame(report$PREVALENCE_BY_MONTH)
      report$LENGTH_OF_ERA <- as.data.frame(report$LENGTH_OF_ERA)

      filename <- paste(outputPath, "/concepts/condition_era/concept_" , format(report$CONCEPT_ID, scientific = FALSE) , ".json", sep='')
      write(jsonlite::toJSON(report), filename)
    },
    outputPath,
    reports
  )
}

#' @title exportToAres
#'
#' @description
#' \code{exportToAres} Exports Achilles statistics for ARES
#'
#' @details
#' Creates export files 
#' 
#' 
#' @param connectionDetails             An R object of type ConnectionDetail (details for the function that contains server info, database type, optionally username/password, port)
#' @param cdmDatabaseSchema             Name of the database schema that contains the OMOP CDM.
#' @param resultsDatabaseSchema     		Name of the database schema that contains the Achilles analysis files. Default is cdmDatabaseSchema
#' @param outputPath		                A folder location to save the JSON files. Default is current working folder
#' @param vocabDatabaseSchema		        string name of database schema that contains OMOP Vocabulary. Default is cdmDatabaseSchema. On SQL Server, this should specifiy both the database and the schema, so for example 'results.dbo'.
#' @param reports                       vector of reports to run, c() defaults to all reports
#' 
#' See \code{showReportTypes} for a list of all report types
#' 
#' @return none 
#' 
#'@importFrom data.table fwrite
#'@importFrom dplyr ntile desc
#'@export
#'
exportToAres <- function(
  connectionDetails, 
  cdmDatabaseSchema, 
  resultsDatabaseSchema, 
  vocabDatabaseSchema, 
  outputPath,
  reports = c())
{
  conn <- DatabaseConnector::connect(connectionDetails)
  on.exit(DatabaseConnector::disconnect(connection = conn))  
  
  # generate a folder name for this release of the cdm characterization
  sql <- SqlRender::render(sql = "select * from @cdmDatabaseSchema.cdm_source;",cdmDatabaseSchema = cdmDatabaseSchema)
  sql <- SqlRender::translate(sql = sql, targetDialect = connectionDetails$dbms)
  metadata <- DatabaseConnector::querySql(conn, sql)
  sourceKey <- gsub(" ","_",metadata$CDM_SOURCE_ABBREVIATION)
  releaseDateKey <- format(lubridate::ymd(metadata$CDM_RELEASE_DATE), "%Y%m%d")
  sourceOutputPath <- file.path(outputPath, sourceKey, releaseDateKey)
  dir.create(sourceOutputPath,showWarnings = F,recursive=T)
  print(paste0("processing AO export to ", sourceOutputPath))
  
  if (length(reports) == 0  || (length(reports) > 0 && "density" %in% reports)) {
    # data density - totals
    renderedSql <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/datadensity/totalrecords.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema
    )  
    
    totalRecordsData <- DatabaseConnector::querySql(conn,renderedSql)
    colnames(totalRecordsData) <- c("domain", "date", "records")  
    totalRecordsData$date <- lubridate::parse_date_time(totalRecordsData$date, "ym")
    data.table::fwrite(totalRecordsData, file=paste0(sourceOutputPath, "/datadensity-total.csv"), scipen = 999)
    
    domainAggregates <- aggregate(totalRecordsData$records, by=list(domain=totalRecordsData$domain), FUN=sum)
    names(domainAggregates) <- c("domain","count_records")
    data.table::fwrite(domainAggregates, file=paste0(sourceOutputPath, "/records-by-domain.csv"), scipen = 999)

    # data density - records per person
    renderedSql <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/datadensity/recordsperperson.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema
    )
    
    recordsPerPerson <- DatabaseConnector::querySql(conn,renderedSql)
    colnames(recordsPerPerson) <- c("domain", "date", "records")
    recordsPerPerson$date <- lubridate::parse_date_time(recordsPerPerson$date, "ym")  
    recordsPerPerson$records <- round(recordsPerPerson$records,2)
    data.table::fwrite(recordsPerPerson, file=paste0(sourceOutputPath, "/datadensity-records-per-person.csv"), scipen = 999)
  
    # data density - concepts  per person
    renderedSql <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/datadensity/conceptsperperson.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema
    )  
    conceptsPerPerson <- DatabaseConnector::querySql(conn,renderedSql)
    data.table::fwrite(conceptsPerPerson, file=paste0(sourceOutputPath, "/datadensity-concepts-per-person.csv"), scipen = 999)
    
    # data density - domains per person
    renderedSql <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/datadensity/domainsperperson.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema
    )  
    domainsPerPerson <- DatabaseConnector::querySql(conn,renderedSql)
    domainsPerPerson$PERCENT_VALUE <- round(as.numeric(domainsPerPerson$PERCENT_VALUE),2)
    data.table::fwrite(domainsPerPerson, file=paste0(sourceOutputPath, "/datadensity-domains-per-person.csv"), scipen = 999)
  }
  
  if (length(reports) == 0  || (length(reports) > 0 && ("domain" %in% reports || "concept" %in% reports))) {
    # metadata 
    generateAOMetadataReport(connectionDetails, cdmDatabaseSchema, sourceOutputPath)
    
    # cdm source
    generateAOCdmSourceReport(connectionDetails, cdmDatabaseSchema, sourceOutputPath)
    
    # domain summary - observation period
    generateAOObservationPeriodReport(connectionDetails, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, sourceOutputPath)   
    
    # death report
    generateAODeathReport(connectionDetails, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, sourceOutputPath)   
    
    # domain summary - conditions
    queryConditions <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/condition/sqlConditionTable.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema,
      vocab_database_schema = vocabDatabaseSchema
    )  
    dataConditions <- DatabaseConnector::querySql(conn,queryConditions)   
    dataConditions$PERCENT_PERSONS <- format(round(dataConditions$PERCENT_PERSONS,4), nsmall=4)
    dataConditions$PERCENT_PERSONS_NTILE <- dplyr::ntile(dplyr::desc(dataConditions$PERCENT_PERSONS),10)
    dataConditions$RECORDS_PER_PERSON <- format(round(dataConditions$RECORDS_PER_PERSON,1),nsmall=1)
    dataConditions$RECORDS_PER_PERSON_NTILE <- dplyr::ntile(dplyr::desc(dataConditions$RECORDS_PER_PERSON),10)
    data.table::fwrite(dataConditions, file=paste0(sourceOutputPath, "/domain-summary-condition_occurrence.csv"), scipen = 999)
    
    # domain summary - condition eras
    queryConditionEra <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/conditionera/sqlConditionEraTable.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema,
      vocab_database_schema = vocabDatabaseSchema
    )  
    dataConditionEra <- DatabaseConnector::querySql(conn,queryConditionEra)   
    dataConditionEra$PERCENT_PERSONS <- format(round(dataConditionEra$PERCENT_PERSONS,4), nsmall=4)
    dataConditionEra$PERCENT_PERSONS_NTILE <- dplyr::ntile(dplyr::desc(dataConditionEra$PERCENT_PERSONS),10)
    dataConditionEra$RECORDS_PER_PERSON <- format(round(dataConditionEra$RECORDS_PER_PERSON,1),nsmall=1)
    dataConditionEra$RECORDS_PER_PERSON_NTILE <- dplyr::ntile(dplyr::desc(dataConditionEra$RECORDS_PER_PERSON),10)
    data.table::fwrite(dataConditionEra, file=paste0(sourceOutputPath, "/domain-summary-condition_era.csv"), scipen = 999)
    
    # domain summary - drugs
    queryDrugs <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/drug/sqlDrugTable.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema,
      vocab_database_schema = vocabDatabaseSchema
    )
    dataDrugs <- DatabaseConnector::querySql(conn,queryDrugs)   
    dataDrugs$PERCENT_PERSONS <- format(round(dataDrugs$PERCENT_PERSONS,4), nsmall=4)
    dataDrugs$PERCENT_PERSONS_NTILE <- dplyr::ntile(dplyr::desc(dataDrugs$PERCENT_PERSONS),10)
    dataDrugs$RECORDS_PER_PERSON <- format(round(dataDrugs$RECORDS_PER_PERSON,1),nsmall=1)
    dataDrugs$RECORDS_PER_PERSON_NTILE <- dplyr::ntile(dplyr::desc(dataDrugs$RECORDS_PER_PERSON),10)
    data.table::fwrite(dataDrugs, file=paste0(sourceOutputPath, "/domain-summary-drug_exposure.csv"), scipen = 999)
    
    # domain stratification by drug type concept
    queryDrugType <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/drug/sqlDomainDrugStratification.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema,
      vocab_database_schema = vocabDatabaseSchema
    )  
    dataDrugType <- DatabaseConnector::querySql(conn,queryDrugType)   
    data.table::fwrite(dataDrugType, file=paste0(sourceOutputPath, "/domain-drug-stratification.csv"), scipen = 999)

    # domain summary - drug era
    queryDrugEra <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/drugera/sqlDrugEraTable.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema,
      vocab_database_schema = vocabDatabaseSchema
    )
    dataDrugEra <- DatabaseConnector::querySql(conn,queryDrugEra)   
    dataDrugEra$PERCENT_PERSONS <- format(round(dataDrugEra$PERCENT_PERSONS,4), nsmall=4)
    dataDrugEra$PERCENT_PERSONS_NTILE <- dplyr::ntile(dplyr::desc(dataDrugEra$PERCENT_PERSONS),10)
    dataDrugEra$RECORDS_PER_PERSON <- format(round(dataDrugEra$RECORDS_PER_PERSON,1),nsmall=1)
    dataDrugEra$RECORDS_PER_PERSON_NTILE <- dplyr::ntile(dplyr::desc(dataDrugEra$RECORDS_PER_PERSON), 10)
    data.table::fwrite(dataDrugEra, file=paste0(sourceOutputPath, "/domain-summary-drug_era.csv"), scipen = 999)
    
    # domain summary - measurements
    queryMeasurements <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/measurement/sqlMeasurementTable.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema,
      vocab_database_schema = vocabDatabaseSchema
    )  
    dataMeasurements <- DatabaseConnector::querySql(conn,queryMeasurements)   
    dataMeasurements$PERCENT_PERSONS <- format(round(dataMeasurements$PERCENT_PERSONS,4), nsmall=4)
    dataMeasurements$PERCENT_PERSONS_NTILE <- dplyr::ntile(dplyr::desc(dataMeasurements$PERCENT_PERSONS), 10)
    dataMeasurements$RECORDS_PER_PERSON <- format(round(dataMeasurements$RECORDS_PER_PERSON,1),nsmall=1)
    dataMeasurements$RECORDS_PER_PERSON_NTILE <- dplyr::ntile(dplyr::desc(dataMeasurements$RECORDS_PER_PERSON), 10)
    data.table::fwrite(dataMeasurements, file=paste0(sourceOutputPath, "/domain-summary-measurement.csv"), scipen = 999)
    
    # domain summary - observations
    queryObservations <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/observation/sqlObservationTable.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema,
      vocab_database_schema = vocabDatabaseSchema
    )  
    dataObservations <- DatabaseConnector::querySql(conn,queryObservations)   
    dataObservations$PERCENT_PERSONS <- format(round(dataObservations$PERCENT_PERSONS,4), nsmall=4)
    dataObservations$PERCENT_PERSONS_NTILE <- dplyr::ntile(dplyr::desc(dataObservations$PERCENT_PERSONS), 10)
    dataObservations$RECORDS_PER_PERSON <- format(round(dataObservations$RECORDS_PER_PERSON,1),nsmall=1)
    dataObservations$RECORDS_PER_PERSON_NTILE <- dplyr::ntile(dplyr::desc(dataObservations$RECORDS_PER_PERSON), 10)
    data.table::fwrite(dataObservations, file=paste0(sourceOutputPath, "/domain-summary-observation.csv"), scipen = 999)
    
    # domain summary - visit details
    queryVisitDetails <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/visitdetail/sqlVisitDetailTreemap.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema,
      vocab_database_schema = vocabDatabaseSchema
    )  
    dataVisitDetails <- DatabaseConnector::querySql(conn,queryVisitDetails)   
    dataVisitDetails$PERCENT_PERSONS <- format(round(dataVisitDetails$PERCENT_PERSONS,4), nsmall=4)
    dataVisitDetails$PERCENT_PERSONS_NTILE <- dplyr::ntile(dplyr::desc(dataVisitDetails$PERCENT_PERSONS),10)
    dataVisitDetails$RECORDS_PER_PERSON <- format(round(dataVisitDetails$RECORDS_PER_PERSON,1),nsmall=1)
    dataVisitDetails$RECORDS_PER_PERSON_NTILE <- dplyr::ntile(dplyr::desc(dataVisitDetails$RECORDS_PER_PERSON),10)
    names(dataVisitDetails)[names(dataVisitDetails) == 'CONCEPT_PATH'] <- 'CONCEPT_NAME'
    data.table::fwrite(dataVisitDetails, file=paste0(sourceOutputPath, "/domain-summary-visit_detail.csv"), scipen = 999)
    
    # domain summary - visits
    queryVisits <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/visit/sqlVisitTreemap.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema,
      vocab_database_schema = vocabDatabaseSchema
    )  
    dataVisits <- DatabaseConnector::querySql(conn,queryVisits)   
    dataVisits$PERCENT_PERSONS <- format(round(dataVisits$PERCENT_PERSONS,4), nsmall=4)
    dataVisits$PERCENT_PERSONS_NTILE <- dplyr::ntile(dplyr::desc(dataVisits$PERCENT_PERSONS),10)
    dataVisits$RECORDS_PER_PERSON <- format(round(dataVisits$RECORDS_PER_PERSON,1),nsmall=1)
    dataVisits$RECORDS_PER_PERSON_NTILE <- dplyr::ntile(dplyr::desc(dataVisits$RECORDS_PER_PERSON),10)
    names(dataVisits)[names(dataVisits) == 'CONCEPT_PATH'] <- 'CONCEPT_NAME'
    data.table::fwrite(dataVisits, file=paste0(sourceOutputPath, "/domain-summary-visit_occurrence.csv"), scipen = 999)
    
    # domain stratification by visit concept
    queryVisits <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/visit/sqlDomainVisitStratification.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema,
      vocab_database_schema = vocabDatabaseSchema
    )  
    dataVisits <- DatabaseConnector::querySql(conn,queryVisits)   
    data.table::fwrite(dataVisits, file=paste0(sourceOutputPath, "/domain-visit-stratification.csv"), scipen = 999)

    # domain summary - procedures
    queryProcedures <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/procedure/sqlProcedureTable.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema,
      vocab_database_schema = vocabDatabaseSchema
    )  
    dataProcedures <- DatabaseConnector::querySql(conn,queryProcedures)   
    dataProcedures$PERCENT_PERSONS <- format(round(dataProcedures$PERCENT_PERSONS,4), nsmall=4)
    dataProcedures$PERCENT_PERSONS_NTILE <- dplyr::ntile(dplyr::desc(dataProcedures$PERCENT_PERSONS),10)
    dataProcedures$RECORDS_PER_PERSON <- format(round(dataProcedures$RECORDS_PER_PERSON,1),nsmall=1)
    dataProcedures$RECORDS_PER_PERSON_NTILE <- dplyr::ntile(dplyr::desc(dataProcedures$RECORDS_PER_PERSON),10)
    data.table::fwrite(dataProcedures, file=paste0(sourceOutputPath, "/domain-summary-procedure_occurrence.csv"), scipen = 999)
    
    # domain summary - devices
    queryDevices <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/device/sqlDeviceTable.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema,
      vocab_database_schema = vocabDatabaseSchema
    )
    dataDevices <- DatabaseConnector::querySql(conn,queryDevices)   
    dataDevices$PERCENT_PERSONS <- format(round(dataDevices$PERCENT_PERSONS,4), nsmall=4)
    dataDevices$PERCENT_PERSONS_NTILE <- dplyr::ntile(dplyr::desc(dataDevices$PERCENT_PERSONS),10)
    dataDevices$RECORDS_PER_PERSON <- format(round(dataDevices$RECORDS_PER_PERSON,1),nsmall=1)
    dataDevices$RECORDS_PER_PERSON_NTILE <- dplyr::ntile(dplyr::desc(dataDevices$RECORDS_PER_PERSON),10)
    data.table::fwrite(dataDevices, file=paste0(sourceOutputPath, "/domain-summary-device_exposure.csv"), scipen = 999)
  }
  
    # domain summary - provider
    queryProviders <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/provider/sqlProviderSpecialty.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema,
      vocab_database_schema = vocabDatabaseSchema
    )  
	writeLines("Generating provider reports")
    dataProviders <- DatabaseConnector::querySql(conn,queryProviders)   
    dataProviders$PERCENT_PERSONS <- format(round(dataProviders$PERCENT_PERSONS,4), nsmall=4)
    data.table::fwrite(dataProviders, file=paste0(sourceOutputPath, "/domain-summary-provider.csv"), scipen = 999)
  
  if (length(reports) == 0  || (length(reports) > 0 && "quality" %in% reports)) {
    # quality - completeness
    queryCompleteness <- SqlRender::loadRenderTranslateSql(
      sqlFilename = "export/quality/sqlCompletenessTable.sql",
      packageName = "Achilles",
      dbms = connectionDetails$dbms,
      results_database_schema = resultsDatabaseSchema
    )  
    dataCompleteness <- DatabaseConnector::querySql(conn,queryCompleteness)   
    dataCompleteness <- dataCompleteness[order(-dataCompleteness$RECORD_COUNT),]
    # prevent downstream crashes with large files
    if (nrow(dataCompleteness) > 100000) {
      dataCompleteness <- dataCompleteness[1:100000,]
    }
    data.table::fwrite(dataCompleteness, file=paste0(sourceOutputPath, "/quality-completeness.csv"), scipen = 999)
  }

  if (length(reports) == 0  || (length(reports) > 0 && "performance" %in% reports)) {      
    generateAOAchillesPerformanceReport(connectionDetails, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, sourceOutputPath)
  }
  
  if (length(reports) == 0  || (length(reports) > 0 && "concept" %in% reports)) {  
    # concept level reporting
    conceptsFolder <- file.path(sourceOutputPath,"concepts")
    dir.create(conceptsFolder,showWarnings = F)
    generateAOVisitReports(connectionDetails, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, sourceOutputPath)
    generateAOVisitDetailReports(connectionDetails, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, sourceOutputPath)    
    generateAOMeasurementReports(connectionDetails, dataMeasurements, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, sourceOutputPath)
    generateAOConditionReports(connectionDetails, dataConditions, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, sourceOutputPath)
    generateAOConditionEraReports(connectionDetails, dataConditionEra, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, sourceOutputPath)
    generateAODrugReports(connectionDetails, dataDrugs, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, sourceOutputPath)
    generateAODeviceReports(connectionDetails, dataDevices, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, sourceOutputPath)    
    generateAODrugEraReports(connectionDetails, dataDrugEra, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, sourceOutputPath)
    generateAOProcedureReports(connectionDetails, dataProcedures, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, sourceOutputPath)
    generateAOObservationReports(connectionDetails, dataObservations, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, sourceOutputPath)    
  }
  
  if (length(reports) == 0  || (length(reports) > 0 && "person" %in% reports)) {
    generateAOPersonReport(connectionDetails, cdmDatabaseSchema, resultsDatabaseSchema, vocabDatabaseSchema, sourceOutputPath)
  }
}
